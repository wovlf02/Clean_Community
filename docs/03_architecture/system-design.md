# 시스템 설계

**관련 문서**: [기술 스택](./tech-stack.md) | [데이터베이스 스키마](../04_database/database-schema.md)

---

## 버전 정보

| 구성요소 | 버전 |
|----------|------|
| Next.js | 14+ |
| TypeScript | 5.x |
| FastAPI | 0.100+ |
| Python | 3.10+ |
| Express.js | 4.x |
| Node.js | 20+ LTS |
| PostgreSQL | 15+ |
| Prisma | 5.x |

---

## 1. 아키텍처 개요

### 1.1 마이크로서비스 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client (Browser)                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │ 사용자A │  │ 사용자B │  │ 사용자C │  │ 사용자D │  │ 사용자E │  ...       │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │
└───────┼────────────┼────────────┼────────────┼────────────┼─────────────────┘
        │            │            │            │            │
        └────────────┴─────┬──────┴────────────┴────────────┘
                           │ HTTPS / WSS
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Cloud Infrastructure                                  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Load Balancer (ALB)                             │ │
│  └──────────────────────────────┬─────────────────────────────────────────┘ │
│                                 │                                            │
│         ┌───────────────────────┼───────────────────────┐                   │
│         │                       │                       │                   │
│         ▼                       ▼                       ▼                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │    Next.js       │  │   Express.js     │  │    FastAPI       │          │
│  │    (Vercel)      │  │   Socket Server  │  │   AI Model       │          │
│  │                  │  │    (EC2/ECS)     │  │   (EC2/ECS)      │          │
│  │ • SSR/SSG        │  │                  │  │                  │          │
│  │ • API Routes     │  │ • WebSocket      │  │ • 감정분석 추론  │          │
│  │ • NextAuth.js    │  │ • Socket.IO      │  │ • .pt 모델 서빙  │          │
│  │ • 프론트엔드     │  │ • 동적 스케일링  │  │ • REST API       │          │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘          │
│           │                     │                     │                     │
│           └─────────────────────┼─────────────────────┘                     │
│                                 │                                            │
│                                 ▼                                            │
│  ┌──────────────┐  ┌──────────────────┐  ┌──────────────┐                  │
│  │   Amazon     │  │   ElastiCache    │  │   Amazon     │                  │
│  │     RDS      │  │    (Redis)       │  │     S3       │                  │
│  │ (PostgreSQL) │  │                  │  │  (Storage)   │                  │
│  │              │  │ • 세션 캐시      │  │              │                  │
│  │ • 사용자 DB  │  │ • Socket Pub/Sub │  │ • 파일 저장  │                  │
│  │ • 게시판 DB  │  │ • Rate Limiting  │  │ • 이미지     │                  │
│  │ • 채팅 DB    │  │                  │  │ • 첨부파일   │                  │
│  └──────────────┘  └──────────────────┘  └──────────────┘                  │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐                                        │
│  │  CloudFront  │  │  CloudWatch  │                                        │
│  │    (CDN)     │  │ (Monitoring) │                                        │
│  │              │  │              │                                        │
│  │ • 정적 파일  │  │ • 로그       │                                        │
│  │ • 이미지     │  │ • 메트릭     │                                        │
│  └──────────────┘  └──────────────┘                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 데이터 흐름

```
[일반 API 흐름]
┌─────────┐      ┌─────────┐      ┌─────────────┐      ┌──────────┐
│ Client  │ ──▶ │ Next.js │ ──▶ │ API Routes  │ ──▶ │PostgreSQL│
│         │ ◀── │         │ ◀── │   (Prisma)  │ ◀── │          │
└─────────┘      └─────────┘      └─────────────┘      └──────────┘

[AI 감정분석 흐름 - 한국어 콘텐츠]
┌─────────┐      ┌─────────┐      ┌─────────────┐      ┌──────────┐
│ Client  │ ──▶ │ Next.js │ ──▶ │  FastAPI    │ ──▶ │ PT Model │
│ (전송)  │      │ Server  │      │ (감정분석)  │      │ (추론)   │
└─────────┘      └─────────┘      └─────────────┘      └──────────┘
     ↑                │                                      │
     │                ◀──────────────────────────────────────┘
     │                       감정분석 결과 반환
     │                              │
     │              ┌───────────────┴───────────────┐
     │              │                               │
     │        악성 표현 없음                   악성 표현 감지
     │              │                               │
     │              ▼                               ▼
     │        정상 등록/전송                   경고 모달 표시
     │                                              │
     │                              ┌───────────────┴───────────────┐
     │                              │                               │
     │                        [수정하기]                     [그대로 처리]
     │                              │                               │
     └──────────────────────────────┘                               ▼
                                                             등록/전송 처리
                                                                    +
                                                         모니터링 대상 등록
                                                                    │
                                                                    ▼
                                                         관리자 대시보드에서
                                                            조회/관리 가능

[실시간 채팅 흐름]
┌─────────┐      ┌─────────┐      ┌─────────────┐      ┌──────────┐
│ Client  │ ◀▶ │   ALB   │ ◀▶ │  Express.js │ ◀▶ │  Redis   │
│(Socket) │     │  (WSS)  │     │ (Socket.IO) │     │ (Pub/Sub)│
└─────────┘      └─────────┘      └─────────────┘      └──────────┘

[상태 관리 흐름 - Client]
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│ User Action  │ ──▶ │   Zustand    │ ──▶ │  UI Update   │
└──────────────┘      │   Store      │      └──────────────┘
                      └──────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ React Query  │ ◀▶ API Server
                    │ (서버 상태)  │
                    └──────────────┘
```

---

## 2. 레이어 구조

### 2.1 Frontend 레이어 (Next.js)

```
┌────────────────────────────────────────────────────────────────────────┐
│                         Presentation Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │    Pages     │  │  Components  │  │    Layouts   │                 │
│  │   (App Dir)  │  │  (Reusable)  │  │              │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
└────────────────────────────────────┬───────────────────────────────────┘
                                     │
┌────────────────────────────────────┼───────────────────────────────────┐
│                          State Layer                                    │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         Zustand Store                             │  │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                   │  │
│  │  │ auth │ │ user │ │ chat │ │ noti │ │socket│                   │  │
│  │  │Store │ │Store │ │Store │ │Store │ │Store │                   │  │
│  │  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                       React Query                                 │  │
│  │                   (서버 상태 캐싱/동기화)                         │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────┬───────────────────────────────────┘
                                     │
┌────────────────────────────────────┼───────────────────────────────────┐
│                        Service Layer                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │
│  │   API    │ │  Socket  │ │   Auth   │ │  Storage │                  │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │                  │
│  │ (fetch)  │ │(socket.io)│ │(NextAuth)│ │  (S3)    │                  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Backend 레이어 (Next.js API Routes)

```
┌────────────────────────────────────────────────────────────────────────┐
│                          API Routes Layer                               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                   │
│  │     Auth     │ │    Board     │ │    Chat      │                   │
│  │   Handlers   │ │   Handlers   │ │   Handlers   │                   │
│  └──────────────┘ └──────────────┘ └──────────────┘                   │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                   │
│  │    Friend    │ │  Dashboard   │ │    User      │                   │
│  │   Handlers   │ │   Handlers   │ │   Handlers   │                   │
│  └──────────────┘ └──────────────┘ └──────────────┘                   │
└────────────────────────────────────┬───────────────────────────────────┘
                                     │
┌────────────────────────────────────┼───────────────────────────────────┐
│                         Service Layer                                   │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    Business Logic Services                        │  │
│  │                                                                   │  │
│  │  • AuthService         • BoardService      • ChatService         │  │
│  │  • UserService         • FriendService     • DashboardService    │  │
│  │  • CommentService      • LikeService       • NotificationService │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    External Services                              │  │
│  │                                                                   │  │
│  │  • S3Service (파일 업로드)    • EmailService (이메일 발송)        │  │
│  │  • AIService (감정분석 API)  • CacheService (Redis)              │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────┬───────────────────────────────────┘
                                     │
┌────────────────────────────────────┼───────────────────────────────────┐
│                       Repository Layer                                  │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         Prisma Client                             │  │
│  │                                                                   │  │
│  │  • prisma.user       • prisma.post      • prisma.comment         │  │
│  │  • prisma.chatRoom   • prisma.message   • prisma.friend          │  │
│  │  • prisma.like       • prisma.notification                       │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────┬───────────────────────────────────┘
                                     │
┌────────────────────────────────────┴───────────────────────────────────┐
│                         PostgreSQL (RDS)                                │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Socket Server 레이어 (Express.js)

```
┌────────────────────────────────────────────────────────────────────────┐
│                     Socket.IO Server                                    │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      Event Handlers                               │  │
│  │                                                                   │  │
│  │  [Namespaces]                                                    │  │
│  │  • /chat         : 채팅 메시지 실시간 전송                        │  │
│  │  • /notification : 알림 실시간 전송                              │  │
│  │  • /presence     : 온라인 상태 동기화                            │  │
│  │                                                                   │  │
│  │  [Events]                                                        │  │
│  │  • connection/disconnect    : 연결 관리                          │  │
│  │  • join_room/leave_room    : 채팅방 참여/퇴장                    │  │
│  │  • send_message            : 메시지 전송                         │  │
│  │  • typing                  : 타이핑 상태                         │  │
│  │  • read_message            : 읽음 처리                           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      Redis Adapter                                │  │
│  │                                                                   │  │
│  │  • 다중 인스턴스 간 이벤트 브로드캐스트                           │  │
│  │  • Room 정보 공유                                                 │  │
│  │  • 세션 상태 동기화                                              │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.4 AI Server 레이어 (FastAPI)

```
┌────────────────────────────────────────────────────────────────────────┐
│                        FastAPI Server                                   │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                       API Endpoints                               │  │
│  │                                                                   │  │
│  │  POST /analyze                                                   │  │
│  │    - 단일 텍스트 감정분석                                        │  │
│  │    - Input: { "text": "분석할 문장" }                            │  │
│  │    - Output: { "labels": ["혐오", "차별"], "scores": [0.8, 0.7] } │  │
│  │                                                                   │  │
│  │  POST /analyze/batch                                             │  │
│  │    - 다중 텍스트 배치 분석                                        │  │
│  │    - Input: { "texts": ["문장1", "문장2", ...] }                 │  │
│  │    - Output: [{ "labels": [...], "scores": [...] }, ...]         │  │
│  │                                                                   │  │
│  │  GET /health                                                     │  │
│  │    - 헬스체크                                                    │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      Model Service                                │  │
│  │                                                                   │  │
│  │  • 모델 로드 (.pt 파일)                                          │  │
│  │  • 토크나이저 초기화                                             │  │
│  │  • 추론 (Inference)                                              │  │
│  │  • 결과 후처리                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      PyTorch Model                                │  │
│  │                                                                   │  │
│  │  • 한국어 텍스트 분류 모델                                        │  │
│  │  • 멀티라벨 분류 (8-9개 라벨)                                    │  │
│  │  • GPU/CPU 추론 지원                                             │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 소켓 서버 동적 할당 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Express.js Socket Server Cluster                           │
│                      (ECS Fargate + Auto Scaling)                            │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    Application Load Balancer                            │ │
│  │                   (WebSocket Sticky Sessions)                           │ │
│  └────────────────────────────────┬───────────────────────────────────────┘ │
│                                   │                                          │
│          ┌────────────────────────┼────────────────────────┐                │
│          │                        │                        │                │
│          ▼                        ▼                        ▼                │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐      │
│  │     Task 1       │    │     Task 2       │    │     Task N       │      │
│  │   (Fargate)      │    │   (Fargate)      │    │   (Fargate)      │      │
│  │                  │    │                  │    │                  │      │
│  │   Socket.IO      │    │   Socket.IO      │    │   Socket.IO      │ ...  │
│  │   Instance       │    │   Instance       │    │   Instance       │      │
│  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘      │
│           │                       │                       │                 │
│           └───────────────────────┼───────────────────────┘                 │
│                                   │                                          │
│                                   ▼                                          │
│                     ┌─────────────────────────┐                             │
│                     │      ElastiCache        │                             │
│                     │        (Redis)          │                             │
│                     │                         │                             │
│                     │  • Socket.IO Adapter    │                             │
│                     │  • Room Management      │                             │
│                     │  • Cross-Instance       │                             │
│                     │    Communication        │                             │
│                     └─────────────────────────┘                             │
│                                                                              │
│  [Auto Scaling Policy]                                                      │
│  • CPU 사용률 70% 이상: Scale Out                                           │
│  • 연결 수 1000개/인스턴스 초과: Scale Out                                  │
│  • 트래픽 감소 시: Scale In (최소 2개 유지)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 인증 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           NextAuth.js 인증 흐름                             │
│                                                                              │
│  [회원가입]                                                                 │
│  ┌────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Client │───▶│ /api/auth/  │───▶│ 비밀번호     │───▶│ PostgreSQL   │   │
│  │        │    │ signup      │    │ BCrypt 해시  │    │ 저장         │   │
│  └────────┘    └──────────────┘    └──────────────┘    └──────────────┘   │
│                                                                              │
│  [로그인]                                                                   │
│  ┌────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Client │───▶│ /api/auth/  │───▶│ NextAuth.js  │───▶│ JWT 발급     │   │
│  │        │◀───│ signin      │◀───│ 검증         │◀───│              │   │
│  └────────┘    └──────────────┘    └──────────────┘    └──────────────┘   │
│                                                                              │
│  [OAuth 로그인]                                                             │
│  ┌────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Client │───▶│ OAuth       │───▶│ Provider     │───▶│ Callback     │   │
│  │        │◀───│ Provider    │◀───│ (Google등)   │◀───│ JWT 발급     │   │
│  └────────┘    └──────────────┘    └──────────────┘    └──────────────┘   │
│                                                                              │
│  [API 호출 (인증 필요)]                                                     │
│  ┌────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Client │───▶│ API Route   │───▶│ getServer    │───▶│ 비즈니스     │   │
│  │ + JWT  │◀───│             │◀───│ Session()    │◀───│ 로직 실행    │   │
│  └────────┘    └──────────────┘    └──────────────┘    └──────────────┘   │
│                                                                              │
│  [Socket 연결 (인증)]                                                       │
│  ┌────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Client │───▶│ Socket.IO   │───▶│ JWT 미들웨어 │───▶│ 연결 승인    │   │
│  │ + JWT  │◀───│ Server      │◀───│ 검증         │◀───│              │   │
│  └────────┘    └──────────────┘    └──────────────┘    └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 파일 업로드 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           파일 업로드 흐름                                   │
│                                                                              │
│  ┌────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Client │───▶│ API Route   │───▶│ Presigned    │───▶│ URL 반환     │   │
│  │        │    │ /upload     │    │ URL 생성     │    │              │   │
│  └────┬───┘    └──────────────┘    └──────────────┘    └──────────────┘   │
│       │                                                                      │
│       │         ┌──────────────┐                                            │
│       └────────▶│    S3에      │                                            │
│    직접 업로드  │  직접 업로드 │                                            │
│                 └──────┬───────┘                                            │
│                        │                                                     │
│                        ▼                                                     │
│                 ┌──────────────┐    ┌──────────────┐                        │
│                 │ CloudFront   │───▶│ 사용자에게   │                        │
│                 │ URL 반환     │    │ 이미지 제공  │                        │
│                 └──────────────┘    └──────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

**최종 업데이트**: 2026년 1월 30일
