# 07. 배포

**관련 문서**: [AWS 배포 가이드](../../07_deployment/aws-deployment.md) | [시스템 설계](../../03_architecture/system-design.md)

---

## 📋 개요

이 문서는 FastAPI 감정분석 서버를 Docker로 컨테이너화하고 AWS ECS Fargate에 배포하는 방법을 설명합니다.

---

## ✅ 체크리스트

- [ ] Dockerfile 작성
- [ ] .dockerignore 설정
- [ ] 로컬 Docker 빌드 및 테스트
- [ ] AWS ECR 레포지토리 생성
- [ ] Docker 이미지 푸시
- [ ] ECS Task Definition 작성
- [ ] ECS Service 생성
- [ ] Application Load Balancer 설정
- [ ] CloudWatch 로깅 설정
- [ ] CI/CD 파이프라인 구성

---

## 1. Docker 설정

### 1.1 Dockerfile

```dockerfile
# 베이스 이미지
FROM python:3.11.9-slim

# 작업 디렉토리 설정
WORKDIR /app

# 시스템 패키지 설치 (필요 시)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 애플리케이션 코드 복사
COPY app/ ./app/

# 모델 파일 복사 (빌드 시점에 models/ 폴더가 있어야 함)
COPY models/ ./models/

# 환경 변수 기본값
ENV HOST=0.0.0.0
ENV PORT=8000
ENV MODEL_PATH=/app/models

# 포트 노출
EXPOSE 8000

# 헬스체크
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" || exit 1

# 서버 실행
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 1.2 .dockerignore

```dockerignore
# Python
__pycache__/
*.py[cod]
*$py.class
.Python
venv/
.venv/
env/

# Git
.git/
.gitignore

# IDE
.idea/
.vscode/

# Tests
tests/
.pytest_cache/
.coverage
htmlcov/

# Docs
docs/
*.md

# 개발 파일
.env
.env.local
*.log

# 불필요한 데이터
data/
```

### 1.3 로컬 빌드 및 테스트

```bash
# 이미지 빌드
docker build -t ai-server:latest .

# 로컬 실행
docker run -p 8000:8000 ai-server:latest

# 헬스체크 테스트
curl http://localhost:8000/health

# 분석 테스트
curl -X POST http://localhost:8000/analyze \
  -H "Content-Type: application/json" \
  -d '{"text": "테스트 메시지"}'
```

---

## 2. AWS ECR 설정

### 2.1 ECR 레포지토리 생성

```bash
# AWS CLI로 레포지토리 생성
aws ecr create-repository \
    --repository-name ai-server \
    --region ap-northeast-2

# 레포지토리 URI 확인
# 예: 123456789012.dkr.ecr.ap-northeast-2.amazonaws.com/ai-server
```

### 2.2 이미지 푸시

```bash
# ECR 로그인
aws ecr get-login-password --region ap-northeast-2 | \
    docker login --username AWS --password-stdin \
    123456789012.dkr.ecr.ap-northeast-2.amazonaws.com

# 이미지 태깅
docker tag ai-server:latest \
    123456789012.dkr.ecr.ap-northeast-2.amazonaws.com/ai-server:latest

# 이미지 푸시
docker push 123456789012.dkr.ecr.ap-northeast-2.amazonaws.com/ai-server:latest
```

---

## 3. ECS 배포

### 3.1 Task Definition

```json
{
  "family": "ai-server",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "1024",
  "memory": "4096",
  "executionRoleArn": "arn:aws:iam::123456789012:role/ecsTaskExecutionRole",
  "containerDefinitions": [
    {
      "name": "ai-server",
      "image": "123456789012.dkr.ecr.ap-northeast-2.amazonaws.com/ai-server:latest",
      "essential": true,
      "portMappings": [
        {
          "containerPort": 8000,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "HOST",
          "value": "0.0.0.0"
        },
        {
          "name": "PORT",
          "value": "8000"
        },
        {
          "name": "MODEL_PATH",
          "value": "/app/models"
        },
        {
          "name": "LOG_LEVEL",
          "value": "INFO"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/ai-server",
          "awslogs-region": "ap-northeast-2",
          "awslogs-stream-prefix": "ecs"
        }
      },
      "healthCheck": {
        "command": ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"],
        "interval": 30,
        "timeout": 10,
        "retries": 3,
        "startPeriod": 60
      }
    }
  ]
}
```

### 3.2 리소스 권장 사양

| 환경 | CPU | Memory | 용도 |
|------|-----|--------|------|
| **개발** | 512 | 2048 | 테스트/개발 |
| **스테이징** | 1024 | 4096 | QA/스테이징 |
| **프로덕션** | 2048 | 8192 | 운영 서버 |

> **참고**: PyTorch 모델 3개를 로드하므로 최소 4GB 메모리 권장

---

## 4. Application Load Balancer

### 4.1 ALB 설정

```yaml
# Target Group 설정
Target Type: IP
Protocol: HTTP
Port: 8000
Health Check Path: /health
Health Check Interval: 30s
Healthy Threshold: 2
Unhealthy Threshold: 3

# Listener 설정
Port: 443 (HTTPS)
Certificate: ACM 인증서
Default Action: Forward to ai-server-tg
```

### 4.2 보안 그룹

```yaml
# ALB 보안 그룹
Inbound:
  - 443/tcp from 0.0.0.0/0 (HTTPS)

# ECS Task 보안 그룹
Inbound:
  - 8000/tcp from ALB Security Group
```

---

## 5. CloudWatch 로깅

### 5.1 로그 그룹 생성

```bash
aws logs create-log-group \
    --log-group-name /ecs/ai-server \
    --region ap-northeast-2
```

### 5.2 로그 보관 정책

```bash
aws logs put-retention-policy \
    --log-group-name /ecs/ai-server \
    --retention-in-days 30
```

---

## 6. Auto Scaling

### 6.1 스케일링 정책

```yaml
# Target Tracking Scaling
Target: CPU Utilization
Target Value: 70%
Scale Out Cooldown: 60s
Scale In Cooldown: 300s

# 용량 설정
Minimum: 1
Desired: 2
Maximum: 10
```

### 6.2 스케일링 조건

| 조건 | 동작 |
|------|------|
| CPU > 70% | Scale Out (인스턴스 추가) |
| CPU < 30% | Scale In (인스턴스 감소) |
| 최소 인스턴스 | 2개 (고가용성) |

---

## 7. CI/CD 파이프라인

### 7.1 GitHub Actions 워크플로우

```yaml
# .github/workflows/deploy-ai-server.yml

name: Deploy AI Server

on:
  push:
    branches: [main]
    paths:
      - 'apps/ai-server/**'

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: ai-server
  ECS_SERVICE: ai-server-service
  ECS_CLUSTER: emotion-community-cluster

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Download model files from S3
        run: |
          aws s3 cp s3://your-bucket/models/ apps/ai-server/models/ --recursive

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd apps/ai-server
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment
```

---

## 8. 배포 체크리스트

| 단계 | 항목 | 상태 |
|------|------|------|
| **Docker** | Dockerfile 작성 | ⬜ |
| | 로컬 빌드 테스트 | ⬜ |
| | 헬스체크 동작 확인 | ⬜ |
| **ECR** | 레포지토리 생성 | ⬜ |
| | 이미지 푸시 | ⬜ |
| **ECS** | Task Definition 생성 | ⬜ |
| | Service 생성 | ⬜ |
| | Task 정상 실행 확인 | ⬜ |
| **ALB** | Target Group 생성 | ⬜ |
| | HTTPS Listener 설정 | ⬜ |
| | 헬스체크 통과 확인 | ⬜ |
| **모니터링** | CloudWatch 로그 확인 | ⬜ |
| | 알람 설정 | ⬜ |
| **CI/CD** | GitHub Actions 설정 | ⬜ |
| | 자동 배포 테스트 | ⬜ |

---

## 9. 모델 파일 관리

### 9.1 S3에 모델 저장

모델 파일(.pt)은 용량이 크므로 S3에 저장하고 빌드 시 다운로드합니다.

```bash
# S3 버킷에 모델 업로드
aws s3 cp models/kcelectra.pt s3://your-bucket/models/
aws s3 cp models/soongsil.pt s3://your-bucket/models/
aws s3 cp models/roberta_base.pt s3://your-bucket/models/
```

### 9.2 빌드 시 다운로드

Dockerfile에서 S3에서 모델을 다운로드하도록 수정할 수 있습니다:

```dockerfile
# 빌드 인자
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY

# AWS CLI 설치 및 모델 다운로드
RUN pip install awscli && \
    aws s3 cp s3://your-bucket/models/ /app/models/ --recursive
```

또는 CI/CD 파이프라인에서 빌드 전에 다운로드합니다 (권장).

---

## 🔗 참고 문서

| 문서 | 경로 | 설명 |
|------|------|------|
| AWS 배포 가이드 | `docs/07_deployment/aws-deployment.md` | 전체 AWS 배포 아키텍처 |
| 시스템 설계 | `docs/03_architecture/system-design.md` | 시스템 아키텍처 다이어그램 |
| 기술 스택 | `docs/03_architecture/tech-stack.md` | AWS 서비스 목록 |

---

**이전 문서**: [06_테스트_및_검증.md](./06_테스트_및_검증.md)
