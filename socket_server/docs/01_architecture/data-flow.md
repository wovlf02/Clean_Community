# 데이터 흐름

**관련 문서**: [시스템 개요](./overview.md) | [디렉토리 구조](./directory-structure.md)

---

## 1. 연결 흐름

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│ Client  │─────▶│  Socket.IO  │─────▶│    Auth     │─────▶│   Handler   │
│         │      │   Server    │      │ Middleware  │      │ Registration│
└─────────┘      └─────────────┘      └─────────────┘      └─────────────┘
     │                                       │                     │
     │           { auth: { token } }         │                     │
     │◀──────────────────────────────────────│                     │
     │                                       │                     │
     │                              JWT 검증 │                     │
     │                                       │                     │
     │                              socket.user = decoded          │
     │                                       │                     │
     │                                       ▼                     │
     │                              ┌─────────────┐                │
     │                              │  연결 성공   │───────────────▶│
     │                              └─────────────┘                │
     │                                                             │
     │◀────────────────────────────────────────────────────────────│
     │                    이벤트 리스너 등록 완료                    │
```

---

## 2. 메시지 전송 흐름

### 2.1 단일 인스턴스

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────┐
│ Sender  │─────▶│   Socket    │─────▶│    Chat     │─────▶│  Room   │
│         │      │   Server    │      │   Handler   │      │ Members │
└─────────┘      └─────────────┘      └─────────────┘      └─────────┘
     │                                       │                   │
     │    send_message { roomId, content }   │                   │
     │──────────────────────────────────────▶│                   │
     │                                       │                   │
     │                              메시지 생성 (UUID)            │
     │                                       │                   │
     │                              io.to(roomId).emit('message') │
     │                                       │──────────────────▶│
     │                                       │                   │
     │◀──────────────────────────────────────│                   │
     │         message_sent { success }      │                   │
```

### 2.2 다중 인스턴스 (Redis Adapter)

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Sender  │────▶│  Instance A │────▶│    Redis    │────▶│  Instance B │
│         │     │             │     │   Pub/Sub   │     │             │
└─────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                      │                    │                    │
                      │    PUBLISH         │                    │
                      │───────────────────▶│                    │
                      │                    │    SUBSCRIBE       │
                      │                    │───────────────────▶│
                      │                    │                    │
                      │                    │                    ▼
                      │                    │            ┌─────────────┐
                      │                    │            │  Receiver   │
                      │                    │            │  (Client)   │
                      │                    │            └─────────────┘
```

---

## 3. 프레즌스 (온라인 상태) 흐름

```
[연결 시]
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│  User   │─────▶│   Socket    │─────▶│  Presence   │
│ Connect │      │   Server    │      │   Handler   │
└─────────┘      └─────────────┘      └─────────────┘
                                             │
                            onlineUsers.set(userId, socketId)
                                             │
                            socket.broadcast.emit('presence_update')
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  Other Clients  │
                                    │ { status: 'online' }
                                    └─────────────────┘

[연결 해제 시]
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│  User   │─────▶│   Socket    │─────▶│  Presence   │
│Disconnect│     │   Server    │      │   Handler   │
└─────────┘      └─────────────┘      └─────────────┘
                                             │
                            onlineUsers.delete(userId)
                                             │
                            socket.broadcast.emit('presence_update')
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  Other Clients  │
                                    │ { status: 'offline', lastSeen }
                                    └─────────────────┘
```

---

## 4. 알림 흐름

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  External   │─────▶│   Socket    │─────▶│ Notification│
│   Service   │      │   Server    │      │   Handler   │
└─────────────┘      └─────────────┘      └─────────────┘
                                                 │
                            userSockets.get(targetUserId)
                                                 │
                            io.to(socketId).emit('notification')
                                                 │
                                                 ▼
                                    ┌─────────────────────┐
                                    │    Target User      │
                                    │ { type, title, ... }│
                                    └─────────────────────┘
```

---

## 5. 에러 처리 흐름

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│ Client  │─────▶│   Socket    │─────▶│   Handler   │
│         │      │   Server    │      │             │
└─────────┘      └─────────────┘      └─────────────┘
     │                                       │
     │                              에러 발생 │
     │                                       │
     │                              logger.error()
     │                                       │
     │◀──────────────────────────────────────│
     │    error { code, message }            │
```

---

**최종 업데이트**: 2026년 1월 31일
